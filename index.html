<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SNDP Loan Portal — Welcome</title>
  <link rel="stylesheet" href="styles.css"/>
  <meta name="color-scheme" content="dark light"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
</head>
<body class="landing">
  <div class="landing-hero">
    <div class="hero-overlay">
      <header class="header">
        <div>
          <div class="title">SNDP Loan Portal</div>
          <div class="sub">Community savings &amp; credit unions inspired by Sree Narayana Guru</div>
        </div>
        <nav class="nav">
          <a href="README.html">Implementation Guide</a>
          <a href="#promptCard">AI Data Prompt</a>
        </nav>
      </header>
      <div class="hero-content">
        <h1>Serve members with confidence.</h1>
        <p>Use the demo logins below to explore the dual experience — a welcoming public member view and a branch manager cockpit with a top-down view of every account.</p>
        <div class="pill-list">



          <span class="pill">Password reset override preview</span>



          <span class="pill">Branch intelligence dashboard</span>
          <span class="pill">Excel / PDF exports</span>
        </div>
      </div>
    </div>
  </div>

  <main class="container landing-content">
    <section class="grid two login-panels">
      <form id="publicLoginForm" class="card glass login-card">
        <h3>Member Login</h3>
        <p class="small">Members view their personal profile, upload receipts, and monitor their loan ledger.</p>
        <label>Username
          <input class="input" name="username" id="memberUsername" autocomplete="username" required value="sanoj1"/>
        </label>
        <label>Password
          <input class="input" name="password" type="password" autocomplete="current-password" required value="demo123"/>
        </label>
        <div class="form-actions">
          <button class="btn" type="submit">Sign in as Member</button>
        </div>
        <p class="form-message" id="memberMsg"></p>
        <div class="small">Try <code>sanoj1 / demo123</code> or <code>reshma2 / demo123</code>.</div>
      </form>

      <form id="managerLoginForm" class="card glass login-card">
        <h3>Manager Command Center</h3>
        <p class="small">Managers unlock branch-wide intelligence, audit logging, and rapid access to every account book.</p>
        <label>Username
          <input class="input" name="username" id="managerUsername" autocomplete="username" required value="manager"/>
        </label>
        <label>Password
          <input class="input" name="password" type="password" autocomplete="current-password" required value="demo123"/>
        </label>
        <div class="form-actions">
          <button class="btn" type="submit">Sign in as Manager</button>
        </div>
        <p class="form-message" id="managerMsg"></p>
        <div class="small">Try <code>manager / demo123</code> or <code>kochi_mgr / demo123</code>.</div>
      </form>
    </section>

    <section class="grid two" style="margin-top:24px;align-items:start">
      <div class="card glass" id="promptCard">
        <h3>AI prompt — generate 10 demo members &amp; Excel books</h3>
        <p class="small">Copy the text below into ChatGPT-5 or another AI assistant. The response will include ten fictional members, ready-to-commit JSON account books, and base64-encoded Excel files you can decode for direct download.</p>
        <textarea id="aiPrompt" class="prompt-box" rows="12" readonly>
You are ChatGPT-5 acting as a dataset generator for the "SNDP Loan Portal" GitHub Pages demo.

Produce TEN fictional SNDP micro-loan members spread across multiple Kerala branches. For each member:
1. Output a JSON object that matches data/users.json with fields:
   - username (lowercase, unique)
   - role = "member"
   - branch (existing or new chapter id)
   - permissions = ["profile:read","profile:update","accounts:read"]
   - full_name, dob (YYYY-MM-DD), address, phone, email, photo = "data/profile_photos/jyo.svg"
   - account_excel = "data/accounts/&lt;username&gt;_account.json"
   - salt and password_hash for the password "demo123" using SHA-256(salt+password) with random 16-char hex salt.
2. Output a companion JSON file named data/accounts/&lt;username&gt;_account.json with fields {"owner","branch","generated", "account": [ ... ]}.
   - Include 18–24 ledger rows over the last 12 months with columns Date (YYYY-MM-DD), Description, Type (Loan, Repayment, Interest, Fee), Amount (positive for disbursements, negative for repayments), Notes.
3. Create an Excel workbook for each member with a sheet "Account" matching the JSON rows, plus a Balance column that cumulatively sums Amount. Return each workbook as base64 for a binary .xlsx file under a key xlsx_base64 inside the account JSON response.

Respond with:
{
  "users": [ ... ten user objects ... ],
  "accounts": {
     "&lt;username&gt;_account.json": {
        "owner": "...",
        "branch": "...",
        "generated": "ISO timestamp",
        "account": [...rows...],
        "xlsx_base64": "base64 encoded .xlsx file for this member"
     },
     ... nine more ...
  }
}

        </textarea>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn" type="button" onclick="copyPrompt()">Copy prompt</button>
          <button class="btn ghost" type="button" onclick="downloadSampleWorkbook()">Download sample Excel</button>
          <span id="promptMsg" class="small" style="flex:1 1 180px"></span>
        </div>
      </div>

    <div class="grid two">
      <div class="card">
        <h3>Login</h3>
        <p class="small">Use the demo accounts below to sign in. All verification happens in your browser.</p>
        <form id="loginForm">
          <label>Username</label>
          <input class="input" id="username" autocomplete="username" required value="manager"/>
          <label>Password</label>
          <input class="input" id="password" type="password" autocomplete="current-password" required value="demo123"/>
          <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button class="btn" type="submit">Sign in</button>
            <span id="loginMsg" class="small" style="flex:1 1 160px"></span>
          </div>
        </form>

      </div>

      <div class="card glass">
        <h3>How the demo works</h3>
        <ul class="small feature-list">
          <li>Branch-aware dashboard summarises total loaned, repayments, and outstanding balance for every member.</li>
          <li>Members can export Excel snapshots, fetch monthly PDF statements, and manage receipt attachments locally.</li>



          <li>Password reset uses an in-browser override stored locally for this static prototype.</li>



          <li>All data loads from <code>data/*.json</code>, making the project Git-friendly and easy to extend.</li>
        </ul>
        <div class="card ghost" style="margin-top:12px">
          <div class="small">Need more guidance?</div>
          <a class="btn" href="README.html" style="margin-top:8px">Open the onboarding guide</a>
        </div>
      </div>
    </section>

    <footer>© SNDP Demo • Built for GitHub Pages • Featuring Sree Narayana Guru</footer>
  </main>



  <div id="resetModal" class="modal hidden">
    <div class="modal-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">Reset password</h3>
        <button class="btn ghost" type="button" onclick="closeReset()">Close</button>
      </div>

      <p class="small">Enter your username to receive a one-time password (OTP). For this offline demo the OTP is shown onscreen instead of being emailed.</p>
      <div class="grid two" style="grid-template-columns:1fr">
        <label>Username<input class="input" id="resetUser"/></label>
        <button class="btn" type="button" onclick="sendOtp()">Send OTP</button>
        <div id="otpArea" class="hidden">
          <label>Enter OTP<input class="input" id="otpInput"/></label>
          <label>New password<input class="input" id="newPassword" type="password"/></label>
          <button class="btn" type="button" onclick="submitReset()">Update password</button>
          <p id="otpStatus" class="small"></p>
        </div>
        <p id="otpHint" class="small"></p>

      </div>
    </div>
  </div>



  <script>
  const USER_CACHE = {data: null};

  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    const bytes = Array.from(new Uint8Array(buf));
    return bytes.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  function recordAudit(entry){
    try{
      const list = JSON.parse(localStorage.getItem('audit_log') || '[]');
      list.push({...entry, ts: new Date().toISOString()});
      while(list.length > 500){ list.shift(); }
      localStorage.setItem('audit_log', JSON.stringify(list));
    }catch(err){
      console.error('audit log failed', err);
    }
  }




  function applyPasswordOverride(rec){
    try{
      const override = JSON.parse(localStorage.getItem('override_' + rec.username) || 'null');
      if(override && override.password_hash && override.salt){
        return {...rec, salt: override.salt, password_hash: override.password_hash};
      }
    }catch(err){
      console.warn('override parse failed', err);
    }
    return rec;
  }

  async function loadUsers(){
    if(USER_CACHE.data){
      return USER_CACHE.data;
    }
    const res = await fetch('data/users.json');
    if(!res.ok){
      throw new Error('Unable to load users.json');
    }
    USER_CACHE.data = await res.json();
    return USER_CACHE.data;
  }


  function getFormMessage(form){
    return form.querySelector('.form-message') || document.getElementById('loginMsg');
  }





  async function handleLogin(ev, expectedRole){
    ev.preventDefault();
    const form = ev.target;
    const userField = form.querySelector('input[name="username"], input#username');
    const passField = form.querySelector('input[name="password"], input#password');
    const msg = getFormMessage(form);
    const username = (userField?.value || '').trim();
    const password = passField?.value || '';

    if(msg){ msg.textContent = 'Checking…'; }
    try{
      const db = await loadUsers();
      let rec = db.users.find(x => x.username === username);
      if(!rec){
        if(msg){ msg.textContent = 'User not found'; }
        return;
      }
      if(expectedRole === 'manager' && rec.role !== 'manager'){
        if(msg){ msg.textContent = 'Use the manager panel to sign in'; }
        return;
      }
      if(expectedRole === 'member' && rec.role !== 'member'){
        if(msg){ msg.textContent = 'Use the manager login instead'; }
        return;
      }




      rec = applyPasswordOverride(rec);

      const hash = await sha256Hex(rec.salt + password);
      if(hash !== rec.password_hash){
        if(msg){ msg.textContent = 'Invalid password'; }
        return;
      }



      const session = {
        username: rec.username,
        role: rec.role,
        branch: rec.branch || null,
        permissions: rec.permissions || [],
        ts: Date.now()
      };
      localStorage.setItem('sndp_session', JSON.stringify(session));
      recordAudit({actor: rec.username, action: 'login', branch: rec.branch || null});
      if(msg){ msg.textContent = 'Login successful. Redirecting…'; }
      location.href = 'app.html';
    }catch(err){
      console.error(err);
      if(msg){ msg.textContent = 'Unable to load users'; }
    }
  }




  function openReset(prefillId){
    if(prefillId){
      const field = document.getElementById(prefillId);
      if(field){
        const value = field.value || field.getAttribute('placeholder') || '';
        document.getElementById('resetUser').value = value;
      }
    }
    document.getElementById('resetModal').classList.remove('hidden');
    document.getElementById('resetUser').focus();
  }

  function closeReset(){
    document.getElementById('resetModal').classList.add('hidden');
    document.getElementById('resetUser').value = '';

    document.getElementById('otpArea').classList.add('hidden');
    document.getElementById('otpStatus').textContent = '';
    document.getElementById('otpHint').textContent = '';
  }

  async function sendOtp(){
    const user = document.getElementById('resetUser').value.trim();
    if(!user){ alert('Enter username'); return; }
    const db = await loadUsers();
    const rec = db.users.find(x => x.username === user);
    if(!rec){ alert('User not found'); return; }
    const code = Math.floor(100000 + Math.random() * 900000).toString();
    localStorage.setItem('otp_' + user, JSON.stringify({code, expires: Date.now() + 10 * 60 * 1000}));
    document.getElementById('otpArea').classList.remove('hidden');
    document.getElementById('otpStatus').textContent = '';
    document.getElementById('otpHint').textContent = `OTP for demo purposes: ${code}`;
    recordAudit({actor: user, action: 'otp_sent', branch: rec.branch || null});
  }

  async function submitReset(){

    const user = document.getElementById('resetUser').value.trim();
    const pass = document.getElementById('newPassword').value;

    const status = document.getElementById('otpStatus');
    if(!otp || !pass){ status.textContent = 'Enter OTP and new password'; return; }
    const stored = localStorage.getItem('otp_' + user);
    if(!stored){ status.textContent = 'No OTP found, request again.'; return; }
    const rec = JSON.parse(stored);
    if(Date.now() > rec.expires){ status.textContent = 'OTP expired. Request a new one.'; return; }
    if(rec.code !== otp){ status.textContent = 'Incorrect OTP.'; return; }
    const salt = Array.from(crypto.getRandomValues(new Uint8Array(8))).map(b => b.toString(16).padStart(2, '0')).join('');
    const hash = await sha256Hex(salt + pass);
    localStorage.setItem('override_' + user, JSON.stringify({salt, password_hash: hash}));
    localStorage.removeItem('otp_' + user);

    status.textContent = 'Password updated. You can now sign in.';
    recordAudit({actor: user, action: 'password_reset_override', branch: rec.branch || null});
  }




  async function downloadSampleWorkbook(){
    try{
      const res = await fetch('data/accounts/sample_account.json');
      const payload = await res.json();
      const dataset = Array.isArray(payload.account) ? payload.account : (payload.rows || []);
      const rows = dataset.map(row => ({...row}));
      let running = 0;
      const sheetRows = rows.map(r => {
        const amt = typeof r.Amount === 'number' ? r.Amount : parseFloat(r.Amount || 0) || 0;
        running += amt;
        return {...r, Balance: running};
      });
      const ws = XLSX.utils.json_to_sheet(sheetRows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Account');
      const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'array'});
      const blob = new Blob([wbout], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'sample_account_book.xlsx';
      a.click();
      URL.revokeObjectURL(a.href);
      const msg = document.getElementById('promptMsg');
      if(msg){ msg.textContent = 'Sample Excel downloaded. Import it into Excel or LibreOffice to explore the format.'; }
    }catch(err){
      console.error(err);
      const msg = document.getElementById('promptMsg');
      if(msg){ msg.textContent = 'Unable to load sample_account.json'; }
    }
  }

  async function copyPrompt(){
    const prompt = document.getElementById('aiPrompt').value;
    try{
      await navigator.clipboard.writeText(prompt);
      const msg = document.getElementById('promptMsg');
      if(msg){ msg.textContent = 'Prompt copied to clipboard.'; }
    }catch(err){
      console.error(err);
      const msg = document.getElementById('promptMsg');
      if(msg){ msg.textContent = 'Copy failed — please select and copy manually.'; }
    }
  }

  function initLoginPanels(){
    const memberForm = document.getElementById('publicLoginForm');
    if(memberForm){ memberForm.addEventListener('submit', ev => handleLogin(ev, 'member')); }
    const managerForm = document.getElementById('managerLoginForm');
    if(managerForm){ managerForm.addEventListener('submit', ev => handleLogin(ev, 'manager')); }
    const genericForm = document.getElementById('loginForm');
    if(genericForm){ genericForm.addEventListener('submit', ev => handleLogin(ev, 'any')); }



    document.querySelectorAll('button[data-reset]').forEach(btn => {
      btn.addEventListener('click', () => openReset(btn.getAttribute('data-reset')));
    });



  }

  document.addEventListener('DOMContentLoaded', () => {
    initLoginPanels();
  });




  window.openReset = openReset;
  window.closeReset = closeReset;

  window.sendOtp = sendOtp;
  window.submitReset = submitReset;



  window.downloadSampleWorkbook = downloadSampleWorkbook;
  window.copyPrompt = copyPrompt;

  </script>
</body>
</html>
